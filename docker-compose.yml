version: '3.8'

services:
  # --- AUTHELIA AUTHENTICATION SERVICE ---
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    volumes:
      - ./authelia:/config
    networks:
      - web
    environment:
      - AUTHELIA_JWT_SECRET_FILE=/config/jwt_secret
      - AUTHELIA_SESSION_SECRET_FILE=/config/session_secret
      - AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE=/config/storage_encryption_key
      - TZ=Europe/Berlin
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`${AUTH_DOMAIN}`)"
      - "traefik.http.routers.authelia.entrypoints=${TRAEFIK_ENTRYPOINT}"
      - "${TRAEFIK_CERTRESOLVER_LABEL}"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # --- FRONTEND SERVICE (Streamlit) ---
  skuld-frontend:
    image: skuld-app-image
    pull_policy: never
    build: .
    container_name: skuld-frontend
    command: /app/start_frontend.sh
    env_file:
      - .env
    volumes:
      - ./financial_data.db:/app/Skuld/db/financial_data.db
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/Berlin
      - SKULD_VERSION=${SKULD_VERSION:-}
    restart: unless-stopped
    networks:
      - web
      - postgres_setup_default
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1000M
        reservations:
          cpus: '0.1'
          memory: 256M

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.skuld.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.skuld.entrypoints=${TRAEFIK_ENTRYPOINT}"
      - "${TRAEFIK_CERTRESOLVER_LABEL}"
      - "traefik.http.services.skuld.loadbalancer.server.port=8501"
      
      # Authelia ForwardAuth Middleware
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=${AUTH_SCHEME}://${AUTH_DOMAIN}/"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"
      
      # Apply Authelia Middleware
      - "traefik.http.routers.skuld.middlewares=authelia"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # --- BACKEND SERVICE (Cron / Scraper) ---
  skuld-backend:
    image: skuld-app-image
    pull_policy: never
    build: .
    container_name: skuld-backend
    command: /app/start_backend.sh
    env_file:
      - .env
    volumes:
      - ./financial_data.db:/app/Skuld/db/financial_data.db
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/Berlin
      - SKULD_VERSION=${SKULD_VERSION:-}
    restart: unless-stopped
    networks:
      - web
      - postgres_setup_default
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 3000M
        reservations:
          cpus: '0.25'
          memory: 512M

networks:
  web:
    external: true
  postgres_setup_default:
    external: true



