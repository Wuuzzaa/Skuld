version: '3.8'

services:
  skuld-app:
    build: .
    container_name: skuld-streamlit
    volumes:
      # Persistent database file only (not entire db folder!)
      - ./financial_data.db:/app/Skuld/db/financial_data.db
      # Persistent logs generated by the application itself
      - ./logs:/app/Skuld/logs
      # Cron logs for debugging (currently commented out)
      #- ./cron.log:/var/log/cron.log
    environment:
      - PYTHONUNBUFFERED=1
      - TZ=Europe/Berlin
      # Telegram Alert Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    restart: unless-stopped
    networks:
      - web
    
    # === DOCKER LOG ROTATION CONFIGURATION ===
    # This prevents the container's output logs (stdout/stderr) from filling up the disk.
    logging:
      driver: "json-file"
      options:
        max-size: "10m" # Maximum size of a single log file (10 MB)
        max-file: "3"   # Keep a maximum of 3 rotated log files
    # ========================================

 # RESOURCE MANAGEMENT: Tailored for 2 vCPUs and 4GB RAM
    deploy:
      resources:
        limits:
          cpus: '1.5'      # Max 75% of your 2 vCPUs
          memory: 1000M    # Max 1GB of your 4GB RAM
        reservations:
          cpus: '0.25'     # Guaranteed minimum CPU share
          memory: 512M     # Guaranteed minimum RAM

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      # Router rule: Use this service when the host is app.skuld-options.com
      - "traefik.http.routers.skuld.rule=Host(`app.skuld-options.com`)"
      # Entrypoint: Use the websecure (HTTPS) entrypoint defined in Traefik
      - "traefik.http.routers.skuld.entrypoints=websecure"
      # TLS: Automatically request and manage an SSL Certificate via Let's Encrypt
      - "traefik.http.routers.skuld.tls.certresolver=letsencrypt"
      # Service definition: Traffic should be forwarded to port 8501 inside the container (Streamlit's default port)
      - "traefik.http.services.skuld.loadbalancer.server.port=8501"
    healthcheck:
      # Check command: Use curl to verify Streamlit's internal health endpoint
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  web:
    external: true # Use a network that is already defined outside this compose file



