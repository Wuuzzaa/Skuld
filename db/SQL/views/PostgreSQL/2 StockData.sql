DROP VIEW IF EXISTS "StockData" CASCADE;

CREATE VIEW
    "StockData" AS
SELECT
	A.SYMBOL,
	A.close as LIVE_STOCK_PRICE,
	B.EARNINGS_DATE,
	CAST(B.EARNINGS_DATE::DATE - CURRENT_DATE AS INTEGER) AS days_to_earnings,
	C.ANALYST_MEAN_TARGET,

	-- StockImpliedVolatilityMassive
    d.iv,
    d.iv_low,
    d.iv_high,
    d.iv_rank,
    d.iv_percentile,
	-- days of options data available
	CAST(CURRENT_DATE - g.from_date AS INTEGER) AS days_of_options_data_history,

	-- StockVolatility
	e.historical_volatility_30d,

	-- DividendData
	f.dividend_growth_years,
	f.dividend_classification,
	f.LAST_DIVIDEND,
    f.LAST_DIVIDEND_DATE,
	f.NO_DIVIDEND_PAYOUTS_LAST_YEAR,
	CAST(CURRENT_DATE - h.from_date AS INTEGER) AS days_of_stock_prices_history,

	-- FundamentalData
	-- FundamentalDataYahoo
	i."asOfDate", 
	i."periodType", 
	i."currencyCode", 
	i."AccountsPayable", 
	i."AccountsReceivable", 
	i."AccruedInterestReceivable", 
	i."AccumulatedDepreciation", 
	i."AdditionalPaidInCapital", 
	i."AllowanceForDoubtfulAccountsReceivable", 
	i."Amortization", 
	i."AmortizationCashFlow", 
	i."AmortizationOfIntangibles", 
	i."AmortizationOfIntangiblesIncomeStatement", 
	i."AmortizationOfSecurities", 
	i."AssetImpairmentCharge", 
	i."AssetsHeldForSaleCurrent", 
	i."AvailableForSaleSecurities", 
	i."AverageDilutionEarnings", 
	i."BasicAverageShares", 
	i."BasicEPS", 
	i."BeginningCashPosition", 
	i."BuildingsAndImprovements", 
	i."CapitalExpenditure", 
	i."CapitalExpenditureReported", 
	i."CapitalLeaseObligations", 
	i."CapitalStock", 
	i."CashAndCashEquivalents", 
	i."CashCashEquivalentsAndShortTermInvestments", 
	i."CashDividendsPaid", 
	i."CashEquivalents", 
	i."CashFinancial", 
	i."CashFlowFromContinuingFinancingActivities", 
	i."CashFlowFromContinuingInvestingActivities", 
	i."CashFlowFromContinuingOperatingActivities", 
	i."CashFlowFromDiscontinuedOperation", 
	i."CashFlowsfromusedinOperatingActivitiesDirect", 
	i."CashFromDiscontinuedFinancingActivities", 
	i."CashFromDiscontinuedInvestingActivities", 
	i."CashFromDiscontinuedOperatingActivities", 
	i."ChangeInAccountPayable", 
	i."ChangeInAccruedExpense", 
	i."ChangeInCashSupplementalAsReported", 
	i."ChangeInDividendPayable", 
	i."ChangeInIncomeTaxPayable", 
	i."ChangeInInterestPayable", 
	i."ChangeInInventory", 
	i."ChangeInOtherCurrentAssets", 
	i."ChangeInOtherCurrentLiabilities", 
	i."ChangeInOtherWorkingCapital", 
	i."ChangeInPayable", 
	i."ChangeInPayablesAndAccruedExpense", 
	i."ChangeInPrepaidAssets", 
	i."ChangeInReceivables", 
	i."ChangeInTaxPayable", 
	i."ChangeInWorkingCapital", 
	i."ChangesInAccountReceivables", 
	i."ChangesInCash", 
	i."ClassesofCashPayments", 
	i."ClassesofCashReceiptsfromOperatingActivities", 
	i."CommercialPaper", 
	i."CommonStock", 
	i."CommonStockDividendPaid", 
	i."CommonStockEquity", 
	i."CommonStockIssuance", 
	i."CommonStockPayments", 
	i."ConstructionInProgress", 
	i."CostOfRevenue", 
	i."CurrentAccruedExpenses", 
	i."CurrentAssets", 
	i."CurrentCapitalLeaseObligation", 
	i."CurrentDebt", 
	i."CurrentDebtAndCapitalLeaseObligation", 
	i."CurrentDeferredAssets", 
	i."CurrentDeferredLiabilities", 
	i."CurrentDeferredRevenue", 
	i."CurrentDeferredTaxesAssets", 
	i."CurrentDeferredTaxesLiabilities", 
	i."CurrentLiabilities", 
	i."CurrentNotesPayable", 
	i."CurrentProvisions", 
	i."DeferredIncomeTax", 
	i."DeferredTax", 
	i."DefinedPensionBenefit", 
	i."Depletion", 
	i."DepletionIncomeStatement", 
	i."Depreciation", 
	i."DepreciationAmortizationDepletion", 
	i."DepreciationAmortizationDepletionIncomeStatement", 
	i."DepreciationAndAmortization", 
	i."DepreciationAndAmortizationInIncomeStatement", 
	i."DepreciationIncomeStatement", 
	i."DerivativeProductLiabilities", 
	i."DilutedAverageShares", 
	i."DilutedEPS", 
	i."DilutedNIAvailtoComStockholders", 
	i."DividendPaidCFO", 
	i."DividendReceivedCFO", 
	i."DividendsPayable", 
	i."DividendsReceivedCFI", 
	i."DuefromRelatedPartiesCurrent", 
	i."DuefromRelatedPartiesNonCurrent", 
	i."DuetoRelatedPartiesCurrent", 
	i."DuetoRelatedPartiesNonCurrent", 
	i."EBIT", 
	i."EBITDA", 
	i."EarningsFromEquityInterest", 
	i."EarningsFromEquityInterestNetOfTax", 
	i."EarningsLossesFromEquityInvestments", 
	i."EffectOfExchangeRateChanges", 
	i."EmployeeBenefits", 
	i."EndCashPosition", 
	i."EnterpriseValue", 
	i."EnterprisesValueEBITDARatio", 
	i."EnterprisesValueRevenueRatio", 
	i."ExcessTaxBenefitFromStockBasedCompensation", 
	i."ExciseTaxes", 
	i."FinancialAssets", 
	i."FinancialAssetsDesignatedasFairValueThroughProfitorLossTotal", 
	i."FinancingCashFlow", 
	i."FinishedGoods", 
	i."FixedAssetsRevaluationReserve", 
	i."ForeignCurrencyTranslationAdjustments", 
	i."FreeCashFlow", 
	i."GainLossOnInvestmentSecurities", 
	i."GainLossOnSaleOfBusiness", 
	i."GainLossOnSaleOfPPE", 
	i."GainOnSaleOfBusiness", 
	i."GainOnSaleOfPPE", 
	i."GainOnSaleOfSecurity", 
	i."GainsLossesNotAffectingRetainedEarnings", 
	i."GeneralAndAdministrativeExpense", 
	i."GeneralPartnershipCapital", 
	i."Goodwill", 
	i."GoodwillAndOtherIntangibleAssets", 
	i."GrossAccountsReceivable", 
	i."GrossPPE", 
	i."GrossProfit", 
	i."HedgingAssetsCurrent", 
	i."HeldToMaturitySecurities", 
	i."ImpairmentOfCapitalAssets", 
	i."IncomeTaxPaidSupplementalData", 
	i."IncomeTaxPayable", 
	i."InsuranceAndClaims", 
	i."InterestExpense", 
	i."InterestExpenseNonOperating", 
	i."InterestIncome", 
	i."InterestIncomeNonOperating", 
	i."InterestPaidCFF", 
	i."InterestPaidCFO", 
	i."InterestPaidSupplementalData", 
	i."InterestPayable", 
	i."InterestReceivedCFI", 
	i."InterestReceivedCFO", 
	i."InventoriesAdjustmentsAllowances", 
	i."Inventory", 
	i."InvestedCapital", 
	i."InvestingCashFlow", 
	i."InvestmentProperties", 
	i."InvestmentinFinancialAssets", 
	i."InvestmentsAndAdvances", 
	i."InvestmentsInOtherVenturesUnderEquityMethod", 
	i."InvestmentsinAssociatesatCost", 
	i."InvestmentsinJointVenturesatCost", 
	i."InvestmentsinSubsidiariesatCost", 
	i."IssuanceOfCapitalStock", 
	i."IssuanceOfDebt", 
	i."LandAndImprovements", 
	i."Leases", 
	i."LiabilitiesHeldforSaleNonCurrent", 
	i."LimitedPartnershipCapital", 
	i."LineOfCredit", 
	i."LoansReceivable", 
	i."LongTermCapitalLeaseObligation", 
	i."LongTermDebt", 
	i."LongTermDebtAndCapitalLeaseObligation", 
	i."LongTermDebtIssuance", 
	i."LongTermDebtPayments", 
	i."LongTermEquityInvestment", 
	i."LongTermProvisions", 
	i."MachineryFurnitureEquipment", 
	i."MarketCap", 
	i."MinimumPensionLiabilities", 
	i."MinorityInterest", 
	i."MinorityInterests", 
	i."NetBusinessPurchaseAndSale", 
	i."NetCommonStockIssuance", 
	i."NetDebt", 
	i."NetForeignCurrencyExchangeGainLoss", 
	i."NetIncome", 
	i."NetIncomeCommonStockholders", 
	i."NetIncomeContinuousOperations", 
	i."NetIncomeDiscontinuousOperations", 
	i."NetIncomeExtraordinary", 
	i."NetIncomeFromContinuingAndDiscontinuedOperation", 
	i."NetIncomeFromContinuingOperationNetMinorityInterest", 
	i."NetIncomeFromContinuingOperations", 
	i."NetIncomeFromTaxLossCarryforward", 
	i."NetIncomeIncludingNoncontrollingInterests", 
	i."NetIntangiblesPurchaseAndSale", 
	i."NetInterestIncome", 
	i."NetInvestmentPropertiesPurchaseAndSale", 
	i."NetInvestmentPurchaseAndSale", 
	i."NetIssuancePaymentsOfDebt", 
	i."NetLongTermDebtIssuance", 
	i."NetNonOperatingInterestIncomeExpense", 
	i."NetOtherFinancingCharges", 
	i."NetOtherInvestingChanges", 
	i."NetPPE", 
	i."NetPPEPurchaseAndSale", 
	i."NetPreferredStockIssuance", 
	i."NetShortTermDebtIssuance", 
	i."NetTangibleAssets", 
	i."NonCurrentAccountsReceivable", 
	i."NonCurrentAccruedExpenses", 
	i."NonCurrentDeferredAssets", 
	i."NonCurrentDeferredLiabilities", 
	i."NonCurrentDeferredRevenue", 
	i."NonCurrentDeferredTaxesAssets", 
	i."NonCurrentDeferredTaxesLiabilities", 
	i."NonCurrentNoteReceivables", 
	i."NonCurrentPensionAndOtherPostretirementBenefitPlans", 
	i."NonCurrentPrepaidAssets", 
	i."NormalizedEBITDA", 
	i."NormalizedIncome", 
	i."NotesReceivable", 
	i."OperatingCashFlow", 
	i."OperatingExpense", 
	i."OperatingGainsLosses", 
	i."OperatingIncome", 
	i."OperatingRevenue", 
	i."OrdinarySharesNumber", 
	i."OtherCashAdjustmentInsideChangeinCash", 
	i."OtherCashAdjustmentOutsideChangeinCash", 
	i."OtherCashPaymentsfromOperatingActivities", 
	i."OtherCashReceiptsfromOperatingActivities", 
	i."OtherCurrentAssets", 
	i."OtherCurrentBorrowings", 
	i."OtherCurrentLiabilities", 
	i."OtherEquityAdjustments", 
	i."OtherEquityInterest", 
	i."OtherGandA", 
	i."OtherIncomeExpense", 
	i."OtherIntangibleAssets", 
	i."OtherInventories", 
	i."OtherInvestments", 
	i."OtherNonCashItems", 
	i."OtherNonCurrentAssets", 
	i."OtherNonCurrentLiabilities", 
	i."OtherNonOperatingIncomeExpenses", 
	i."OtherOperatingExpenses", 
	i."OtherPayable", 
	i."OtherProperties", 
	i."OtherReceivables", 
	i."OtherShortTermInvestments", 
	i."OtherSpecialCharges", 
	i."OtherTaxes", 
	i."OtherunderPreferredStockDividend", 
	i."Payables", 
	i."PayablesAndAccruedExpenses", 
	i."PaymentsonBehalfofEmployees", 
	i."PensionAndEmployeeBenefitExpense", 
	i."PensionandOtherPostRetirementBenefitPlansCurrent", 
	i."PreferredSecuritiesOutsideStockEquity", 
	i."PreferredSharesNumber", 
	i."PreferredStock", 
	i."PreferredStockDividendPaid", 
	i."PreferredStockDividends", 
	i."PreferredStockEquity", 
	i."PreferredStockIssuance", 
	i."PreferredStockPayments", 
	i."PrepaidAssets", 
	i."PretaxIncome", 
	i."ProceedsFromStockOptionExercised", 
	i."Properties", 
	i."ProvisionForDoubtfulAccounts", 
	i."ProvisionandWriteOffofAssets", 
	i."PurchaseOfBusiness", 
	i."PurchaseOfIntangibles", 
	i."PurchaseOfInvestment", 
	i."PurchaseOfInvestmentProperties", 
	i."PurchaseOfPPE", 
	i."RawMaterials", 
	i."Receivables", 
	i."ReceivablesAdjustmentsAllowances", 
	i."ReconciledCostOfRevenue", 
	i."ReconciledDepreciation", 
	i."RentAndLandingFees", 
	i."RentExpenseSupplemental", 
	i."RepaymentOfDebt", 
	i."RepurchaseOfCapitalStock", 
	i."ResearchAndDevelopment", 
	i."RestrictedCash", 
	i."RestructuringAndMergernAcquisition", 
	i."RetainedEarnings", 
	i."SalariesAndWages", 
	i."SaleOfBusiness", 
	i."SaleOfIntangibles", 
	i."SaleOfInvestment", 
	i."SaleOfInvestmentProperties", 
	i."SaleOfPPE", 
	i."SecuritiesAmortization", 
	i."SellingAndMarketingExpense", 
	i."SellingGeneralAndAdministration", 
	i."ShareIssued", 
	i."ShortTermDebtIssuance", 
	i."ShortTermDebtPayments", 
	i."SpecialIncomeCharges", 
	i."StockBasedCompensation", 
	i."StockholdersEquity", 
	i."TangibleBookValue", 
	i."TaxEffectOfUnusualItems", 
	i."TaxProvision", 
	i."TaxRateForCalcs", 
	i."TaxesReceivable", 
	i."TaxesRefundPaid", 
	i."TotalAssets", 
	i."TotalCapitalization", 
	i."TotalDebt", 
	i."TotalEquityGrossMinorityInterest", 
	i."TotalExpenses", 
	i."TotalLiabilitiesNetMinorityInterest", 
	i."TotalNonCurrentAssets", 
	i."TotalNonCurrentLiabilitiesNetMinorityInterest", 
	i."TotalOperatingIncomeAsReported", 
	i."TotalOtherFinanceCost", 
	i."TotalPartnershipCapital", 
	i."TotalRevenue", 
	i."TotalTaxPayable", 
	i."TotalUnusualItems", 
	i."TotalUnusualItemsExcludingGoodwill", 
	i."TradeandOtherPayablesNonCurrent", 
	i."TradingSecurities", 
	i."TreasurySharesNumber", 
	i."TreasuryStock", 
	i."UnrealizedGainLoss", 
	i."UnrealizedGainLossOnInvestmentSecurities", 
	i."WorkInProcess", 
	i."WorkingCapital", 
	i."WriteOff", 
	i."InterestPaidDirect", 
	i."InterestReceivedDirect", 
	i."PaymentstoSuppliersforGoodsandServices", 
	i."ReceiptsfromCustomers", 
	i."RestrictedCommonStock", 
	i."TaxesRefundPaidDirect", 
	i."KeyStats_maxAge", 
	i."KeyStats_priceHint", 
	i."KeyStats_enterpriseValue", 
	i."KeyStats_forwardPE", 
	i."KeyStats_profitMargins", 
	i."KeyStats_floatShares", 
	i."KeyStats_sharesOutstanding", 
	i."KeyStats_sharesShort", 
	i."KeyStats_sharesShortPriorMonth", 
	i."KeyStats_sharesShortPreviousMonthDate", 
	i."KeyStats_dateShortInterest", 
	i."KeyStats_sharesPercentSharesOut", 
	i."KeyStats_heldPercentInsiders", 
	i."KeyStats_heldPercentInstitutions", 
	i."KeyStats_shortRatio", 
	i."KeyStats_shortPercentOfFloat", 
	i."KeyStats_beta", 
	i."KeyStats_impliedSharesOutstanding", 
	i."KeyStats_category", 
	i."KeyStats_bookValue", 
	i."KeyStats_priceToBook", 
	i."KeyStats_fundFamily", 
	i."KeyStats_legalType", 
	i."KeyStats_lastFiscalYearEnd", 
	i."KeyStats_nextFiscalYearEnd", 
	i."KeyStats_mostRecentQuarter", 
	i."KeyStats_earningsQuarterlyGrowth", 
	i."KeyStats_netIncomeToCommon", 
	i."KeyStats_trailingEps", 
	i."KeyStats_forwardEps", 
	i."KeyStats_lastSplitFactor", 
	i."KeyStats_lastSplitDate", 
	i."KeyStats_enterpriseToRevenue", 
	i."KeyStats_enterpriseToEbitda", 
	i."KeyStats_52WeekChange", 
	i."KeyStats_SandP52WeekChange", 
	i."KeyStats_lastDividendValue", 
	i."KeyStats_lastDividendDate", 
	i."KeyStats_latestShareClass", 
	i."KeyStats_leadInvestor", 
	i."Forward_EPS_Growth_Percent", 
	i."Summary_maxAge", 
	i."Summary_priceHint", 
	i."Summary_previousClose", 
	i."Summary_open", 
	i."Summary_dayLow", 
	i."Summary_dayHigh", 
	i."Summary_regularMarketPreviousClose", 
	i."Summary_regularMarketOpen", 
	i."Summary_regularMarketDayLow", 
	i."Summary_regularMarketDayHigh", 
	i."Summary_dividendRate", 
	i."Summary_dividendYield", 
	i."Summary_exDividendDate", 
	i."Summary_payoutRatio", 
	i."Summary_fiveYearAvgDividendYield", 
	i."Summary_beta", 
	i."Summary_trailingPE", 
	i."Summary_forwardPE", 
	i."Summary_volume", 
	i."Summary_regularMarketVolume", 
	i."Summary_averageVolume", 
	i."Summary_averageVolume10days", 
	i."Summary_averageDailyVolume10Day", 
	i."Summary_bid", 
	i."Summary_ask", 
	i."Summary_bidSize", 
	i."Summary_askSize", 
	i."Summary_marketCap", 
	i."Summary_fiftyTwoWeekLow", 
	i."Summary_fiftyTwoWeekHigh", 
	i."Summary_allTimeHigh", 
	i."Summary_allTimeLow", 
	i."Summary_priceToSalesTrailing12Months", 
	i."Summary_fiftyDayAverage", 
	i."Summary_twoHundredDayAverage", 
	i."Summary_trailingAnnualDividendRate", 
	i."Summary_trailingAnnualDividendYield", 
	i."Summary_currency", 
	i."Summary_fromCurrency", 
	i."Summary_toCurrency", 
	i."Summary_lastMarket", 
	i."Summary_coinMarketCapLink", 
	i."Summary_algorithm", 
	i."Summary_tradeable", 
	i."FinData_maxAge", 
	i."FinData_currentPrice", 
	i."FinData_targetHighPrice", 
	i."FinData_targetLowPrice", 
	i."FinData_targetMeanPrice", 
	i."FinData_targetMedianPrice", 
	i."FinData_recommendationMean", 
	i."FinData_recommendationKey", 
	i."FinData_numberOfAnalystOpinions", 
	i."FinData_totalCash", 
	i."FinData_totalCashPerShare", 
	i."FinData_ebitda", 
	i."FinData_totalDebt", 
	i."FinData_quickRatio", 
	i."FinData_currentRatio", 
	i."FinData_totalRevenue", 
	i."FinData_debtToEquity", 
	i."FinData_revenuePerShare", 
	i."FinData_returnOnAssets", 
	i."FinData_returnOnEquity", 
	i."FinData_grossProfits", 
	i."FinData_freeCashflow", 
	i."FinData_operatingCashflow", 
	i."FinData_earningsGrowth", 
	i."FinData_revenueGrowth", 
	i."FinData_grossMargins", 
	i."FinData_ebitdaMargins", 
	i."FinData_operatingMargins", 
	i."FinData_profitMargins", 
	i."FinData_financialCurrency", 
	i."KeyStats_ytdReturn", 
	i."KeyStats_beta3Year", 
	i."KeyStats_totalAssets", 
	i."KeyStats_yield", 
	i."KeyStats_fundInceptionDate", 
	i."KeyStats_threeYearAverageReturn", 
	i."KeyStats_fiveYearAverageReturn", 
	i."Summary_yield", 
	i."Summary_totalAssets", 
	i."Summary_navPrice",
	-- StockAssetProfilesYahoo
	i.company_name,
	i.company_industry,
	i.company_sector,
	i.company_country,
	i.company_long_business_summary
FROM
	"StockPricesYahoo" AS A
	LEFT OUTER JOIN (
		SELECT
			SYMBOL,
			CASE
				WHEN EARNINGS_DATE LIKE '%.%.%' THEN SUBSTR(EARNINGS_DATE, 7, 4) || '-' || SUBSTR(EARNINGS_DATE, 4, 2) || '-' || SUBSTR(EARNINGS_DATE, 1, 2)
				ELSE NULL
			END AS EARNINGS_DATE
		FROM
			"EarningDates"
	) AS B ON A.SYMBOL = B.SYMBOL
	LEFT OUTER JOIN "AnalystPriceTargets" AS C ON A.SYMBOL = C.SYMBOL
	LEFT OUTER JOIN "StockImpliedVolatilityMassive" AS d ON a.symbol = d.symbol
	LEFT OUTER JOIN "StockVolatility" AS E ON A.SYMBOL = E.SYMBOL
	LEFT OUTER JOIN "DividendData" AS F ON A.SYMBOL = F.SYMBOL
	LEFT OUTER JOIN (
		SELECT symbol, MIN(from_date) AS from_date FROM "OptionDataMassiveMasterData" GROUP BY symbol
	) AS G ON A.SYMBOL = G.SYMBOL
	LEFT OUTER JOIN (
		SELECT symbol, MIN(from_date) AS from_date FROM "StockPricesYahooMasterData" GROUP BY symbol
	) AS H ON A.SYMBOL = H.SYMBOL
	LEFT OUTER JOIN "FundamentalData" AS I
	ON A.SYMBOL = I.SYMBOL;